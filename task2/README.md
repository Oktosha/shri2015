Задание №2
==========

Существует API, которое умеет отвечать по трём URL: /countries, /cities и /populations. Клиентское приложение подсчитывает численность населения в Африке. Запросы друг от друга не зависят. Чтобы браузер пользователя не простаивал, клиентскому приложению важно уметь делать все три запроса одновременно. Реализацией API является функция getData(url, callback), которая принимает строку с URL запроса и функцию обратного вызова. В случае ошибки в callback первым аргументом будет передана строка ошибки, в случае успеха вторым аргументом будет передан ответ API.

Вам досталась реализация клиентского приложения, которое должно решать описанную выше задачу. Но в коде приложения есть ошибки, из-за которых фактический результат работы отличается от ожидаемого. Сам код [здесь](https://gist.github.com/verkholantsev/4d14ce053b009dac1225).

Как должно быть: приложение выводит в консоль суммарную популяцию в Африке.
Как на самом деле: приложение не выводит в консоль ничего.

**Задание**

1. Найдите ошибку в коде приложения, из-за которой реальный результат работы отличается от ожидаемого. Опишите, как эта ошибка могла возникнуть и как её избежать в будущем.
2. Добавьте в приложение новую возможность — диалог с пользователем. Приложение спрашивает название страны или города, а затем показывает численность населения. Для диалога можно использовать window.prompt.

Результат пришлите в виде двух ссылок: на работающий пример и на исходный код на GitHub.


Решение
=======

Часть 1. Найти и исправить ошибку
---------------------------------

Открываю код в brackets, устраняю почти всё, на что ругается JSLint: неправильные отступы, отсутствие 'use strict', использование переменных без объявления, и т. д. Это исправляет первую серьёзную ошибку: переменная i являлась глобальной. Это могло привести к тому, что циклы бы крутились как-то не так, затирая счётчики друг друга.

Остаётся последняя ошибка JSLint — Don't make functions within a loop. Но прежде чем разбираться с ней, посмотрю, что на самом деле происходит в коде. Использую отладчик Google Chrome, вот [инструкция](https://learn.javascript.ru/debugging-chrome). Итак, что же происходит в коде и почему на консоль ничего не выведено?

Сначала происходит три вызова функции getData. Потом, после задержки, которую создана с помощью setTimeout, происходит три вызова функции callback. Предполагается, что каждый вызов запишет результат запроса в нужное поле массива responses, а последний из них (т. е. тот, который обнаружит, что уже получено 3 ответа) соберёт данные воедино и выведет результат на консоль. Однако, есть проблема: все вызовы callback записывают ответы в одно и то же место — responses['/populations']. Из-за этого в массиве responses не накапливается 3 элемента и обработки данных не происходит. Дело в том, что callback не знает, какое значение было у переменной request в тот момент, когда его вызвали. Функция callback при исполнении использует текущее значение переменной request, а оно к тому времени равно '/populations'.

Как такая ошибка могла возникнуть? От непонимания, того, как устроены пространства имёт в javascript и как именно происходит захват переменной из внешнего контекста. Например, мог сказаться опыт написания кода на C++, где по умолчанию захват переменной лямбда-выражением происходит по значению.

Как исправить ошибку? Необходимо, чтобы у каждого callback была своя копия request с нужным значением. Как это реализовать? Я сделаю так, как описано в [объяснении](http://jslinterrors.com/dont-make-functions-within-a-loop) ошибки «Don't make functions within a loop»: напишу фабрику.

Как её избежать? Почитать про пространства имён в javascript. Использовать JSLint и уделять внимание его предупреждениям.

Часть 2. Добавить новую возможность
-----------------------------------